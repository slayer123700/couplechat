<script>
    // Global variables
    let player;
    let isPlaying = false;
    let playerReady = false;
    let currentRoomCode = '';
    let userName = '';
    let socket;
    let localStream;
    let peerConnections = {};
    let setupComplete = false;

    // Initialize heart background
    function createHearts() {
        const heartsContainer = document.getElementById('hearts');
        const heartCount = 20;
        
        for (let i = 0; i < heartCount; i++) {
            const heart = document.createElement('div');
            heart.className = 'heart';
            heart.innerHTML = '❤️';
            heart.style.left = Math.random() * 100 + 'vw';
            heart.style.top = Math.random() * 100 + 'vh';
            heart.style.fontSize = (Math.random() * 20 + 10) + 'px';
            heart.style.animationDuration = (Math.random() * 10 + 15) + 's';
            heart.style.animationDelay = (Math.random() * 5) + 's';
            heartsContainer.appendChild(heart);
        }
    }
    
    // Generate random room code
    function generateRoomCode() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let code = '';
        for (let i = 0; i < 6; i++) {
            code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return code;
    }
    
    // Update URL with room code
    function updateUrlWithRoom(roomCode) {
        const url = new URL(window.location);
        url.searchParams.set('room', roomCode);
        window.history.pushState({}, '', url);
    }
    
    // Get room code from URL
    function getRoomFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('room');
    }

    // Enhanced YouTube API loading with timeout
    function loadYouTubeAPI() {
        if (window.YT && window.YT.loaded) {
            initializePlayer();
            return;
        }
        
        // Create script tag
        const tag = document.createElement('script');
        tag.src = 'https://www.youtube.com/iframe_api';
        tag.id = 'youtube-iframe-api';
        
        // Add error handling
        tag.onerror = function() {
            addMessage('System', 'Failed to load YouTube API. Please check your internet connection.', 'received');
        };
        
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        
        // Add timeout in case API fails to load
        setTimeout(() => {
            if (!window.YT) {
                addMessage('System', 'YouTube API failed to load after 10 seconds. Please refresh the page.', 'received');
            }
        }, 10000);
    }
    
    // Initialize player when API is ready
    function initializePlayer() {
        if (playerReady || !setupComplete) return;
        
        if (!document.getElementById('youtube-player')) {
            console.error('YouTube player container not found');
            return;
        }
        
        player = new YT.Player('youtube-player', {
            height: '100%',
            width: '100%',
            videoId: 'dQw4w9WgXcQ',
            playerVars: {
                'playsinline': 1,
                'rel': 0,
                'modestbranding': 1,
                'enablejsapi': 1
            },
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange,
                'onError': function(event) {
                    console.error("YouTube Player Error:", event);
                    addMessage('System', 'YouTube player error occurred. Please refresh the page.', 'received');
                }
            }
        });
    }
    
    // YouTube API ready callback
    window.onYouTubeIframeAPIReady = function() {
        console.log("YouTube API is ready");
        if (setupComplete) {
            initializePlayer();
        }
    };
    
    function onPlayerReady(event) {
        console.log("Player is ready");
        playerReady = true;
        const playPauseBtn = document.getElementById('play-pause-btn');
        if (playPauseBtn) {
            playPauseBtn.textContent = '⏸';
        }
        isPlaying = true;
        addMessage('System', 'YouTube player is ready!', 'received');
    }
    
    function onPlayerStateChange(event) {
        console.log("Player state changed:", event.data);
        const playPauseBtn = document.getElementById('play-pause-btn');
        if (!playPauseBtn) return;
        
        if (event.data == YT.PlayerState.PLAYING) {
            playPauseBtn.textContent = '⏸';
            isPlaying = true;
        } else if (event.data == YT.PlayerState.PAUSED || event.data == YT.PlayerState.ENDED) {
            playPauseBtn.textContent = '▶';
            isPlaying = false;
        }
    }

    // Login functionality
    document.getElementById('login-btn').addEventListener('click', function() {
        const username = document.getElementById('username').value.trim();
        const roomInput = document.getElementById('room');
        const usernameError = document.getElementById('username-error');
        
        if (!username) {
            usernameError.style.display = 'block';
            return;
        } else {
            usernameError.style.display = 'none';
        }
        
        // Get or generate room code
        let roomCode = roomInput.value.trim().toUpperCase();
        if (!roomCode) {
            roomCode = generateRoomCode();
        }
        
        currentRoomCode = roomCode;
        userName = username;
        
        const loginScreen = document.getElementById('login-screen');
        const mainScreen = document.getElementById('main-screen');
        
        // Set user info
        document.getElementById('display-username').textContent = username;
        document.getElementById('avatar').textContent = username.charAt(0).toUpperCase();
        document.getElementById('room-code-display').textContent = roomCode;
        
        loginScreen.style.display = 'none';
        mainScreen.style.display = 'block';
        
        // Update URL with room code
        updateUrlWithRoom(roomCode);
        
        // Connect to server
        connectToServer();
        
        addMessage('System', `You've joined room ${roomCode}.`, 'received');
        
        if (roomInput.value.trim() === '') {
            addMessage('System', 'You created a new room. Share the room code with your partner to start watching together.', 'received');
        } else {
            addMessage('System', `You joined room ${roomCode}. Waiting for your partner to confirm connection...`, 'received');
        }
    });
    
    // Connect to server
    function connectToServer() {
        socket = io();
        
        socket.on('connect', () => {
            console.log('Connected to server');
            // Join the room after connection
            socket.emit('join-room', { 
                roomId: currentRoomCode, 
                username: userName 
            });
            
            // Mark setup as complete and initialize player
            setupComplete = true;
            if (window.YT && window.YT.loaded) {
                initializePlayer();
            }
        });
        
        socket.on('connect_error', (error) => {
            console.error('Connection error:', error);
            addMessage('System', 'Connection failed. Please check your internet connection.', 'received');
        });
        
        // Handle real-time events
        setupSocketListeners();
    }
    
    function setupSocketListeners() {
        // User connected
        socket.on('user-connected', (data) => {
            addMessage('System', `${data.username} has joined the room!`, 'received');
        });
        
        // User disconnected
        socket.on('user-disconnected', (data) => {
            addMessage('System', `${data.username} has left the room`, 'received');
        });
        
        // Chat messages
        socket.on('chat-message', (data) => {
            addMessage(data.username, data.message, 'received');
        });
        
        // Video playback updates
        socket.on('playback-update', (data) => {
            if (!playerReady) return;
            
            // Update playback state
            if (typeof data.isPlaying === 'boolean') {
                if (data.isPlaying) {
                    player.playVideo();
                } else {
                    player.pauseVideo();
                }
            }
            
            if (typeof data.currentTime === 'number') {
                player.seekTo(data.currentTime);
            }
            
            if (typeof data.playbackRate === 'number') {
                player.setPlaybackRate(data.playbackRate);
                document.getElementById('speed-select').value = data.playbackRate;
            }
            
            if (typeof data.quality === 'string' && data.quality !== 'auto') {
                player.setPlaybackQuality(data.quality);
                document.getElementById('quality-select').value = data.quality;
            }
        });
        
        // Video change
        socket.on('video-updated', (data) => {
            if (!playerReady) return;
            
            if (data.videoId) {
                player.loadVideoById(data.videoId);
                isPlaying = true;
                document.getElementById('play-pause-btn').textContent = '⏸';
                addMessage('System', `Now playing video: ${data.videoId}`, 'received');
            }
        });
        
        // WebRTC voice chat
        socket.on('voice-offer', async (data) => {
            try {
                const { from, offer } = data;
                const pc = createPeerConnection(from);
                await pc.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                socket.emit('voice-answer', { to: from, answer });
            } catch (error) {
                console.error('Error handling voice offer:', error);
            }
        });
        
        socket.on('voice-answer', async (data) => {
            try {
                const { from, answer } = data;
                if (peerConnections[from]) {
                    await peerConnections[from].setRemoteDescription(new RTCSessionDescription(answer));
                }
            } catch (error) {
                console.error('Error handling voice answer:', error);
            }
        });
        
        socket.on('voice-candidate', async (data) => {
            try {
                const { from, candidate } = data;
                if (peerConnections[from]) {
                    await peerConnections[from].addIceCandidate(new RTCIceCandidate(candidate));
                }
            } catch (error) {
                console.error('Error handling voice candidate:', error);
            }
        });
    }
    
    // Generate room code button
    document.getElementById('generate-room').addEventListener('click', function() {
        const roomCode = generateRoomCode();
        document.getElementById('room').value = roomCode;
    });
    
    // Copy room code to clipboard
    document.getElementById('copy-room-btn').addEventListener('click', function() {
        const roomCode = document.getElementById('room-code-display').textContent;
        navigator.clipboard.writeText(roomCode).then(() => {
            const btn = this;
            const originalText = btn.textContent;
            btn.textContent = 'Copied!';
            setTimeout(() => {
                btn.textContent = originalText;
            }, 2000);
        });
    });
    
    // Logout functionality
    document.getElementById('logout-btn').addEventListener('click', function() {
        // Disconnect from socket
        if (socket) {
            socket.disconnect();
        }
        
        // Stop any active streams
        stopVoice();
        
        document.getElementById('main-screen').style.display = 'none';
        document.getElementById('login-screen').style.display = 'block';
        document.getElementById('username').value = '';
        document.getElementById('room').value = '';
        currentRoomCode = '';
        
        // Remove room from URL
        const url = new URL(window.location);
        url.searchParams.delete('room');
        window.history.pushState({}, '', url);
        
        addMessage('System', 'You have left the room.', 'received');
    });
    
    // Chat functionality
    document.getElementById('send-btn').addEventListener('click', sendMessage);
    document.getElementById('message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') sendMessage();
    });
    
    function sendMessage() {
        const input = document.getElementById('message-input');
        const message = input.value.trim();
        if (message && socket && socket.connected) {
            // Add local message
            addMessage(userName, message, 'sent');
            
            // Send to server
            socket.emit('chat-message', {
                message: message,
                roomId: currentRoomCode
            });
            
            input.value = '';
        } else if (!socket || !socket.connected) {
            addMessage('System', 'Cannot send message: not connected to server.', 'received');
        }
    }
    
    function addMessage(username, text, type) {
        const messagesContainer = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        
        const now = new Date();
        const timeString = now.getHours().toString().padStart(2, '0') + ':' + 
                          now.getMinutes().toString().padStart(2, '0');
        
        messageDiv.innerHTML = `
            <div class="message-header">
                <span class="message-username">${username}</span>
                <span class="message-time">${timeString}</span>
            </div>
            <div>${text}</div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // Control buttons
    document.getElementById('play-pause-btn').addEventListener('click', function() {
        if (!playerReady) {
            addMessage('System', 'Player is not ready yet. Please wait...', 'received');
            return;
        }
        
        if (isPlaying) {
            player.pauseVideo();
            sendPlaybackCommand({
                isPlaying: false,
                currentTime: player.getCurrentTime()
            });
        } else {
            player.playVideo();
            sendPlaybackCommand({
                isPlaying: true,
                currentTime: player.getCurrentTime()
            });
        }
    });
    
    document.getElementById('stop-btn').addEventListener('click', function() {
        if (!playerReady) return;
        player.stopVideo();
        isPlaying = false;
        document.getElementById('play-pause-btn').textContent = '▶';
        
        sendPlaybackCommand({
            isPlaying: false,
            currentTime: 0
        });
    });
    
    document.getElementById('speed-select').addEventListener('change', function() {
        if (!playerReady) return;
        const speed = parseFloat(this.value);
        player.setPlaybackRate(speed);
        
        sendPlaybackCommand({
            playbackRate: speed,
            currentTime: player.getCurrentTime(),
            isPlaying: isPlaying
        });
    });
    
    document.getElementById('quality-select').addEventListener('change', function() {
        if (!playerReady) return;
        const quality = this.value;
        if (quality !== 'auto') {
            player.setPlaybackQuality(quality);
        }
        
        sendPlaybackCommand({
            quality: quality,
            currentTime: player.getCurrentTime(),
            isPlaying: isPlaying
        });
    });
    
    document.getElementById('load-btn').addEventListener('click', function() {
        const url = document.getElementById('video-url').value.trim();
        if (url && playerReady) {
            let videoId = '';
            
            // Extract video ID from URL
            try {
                if (url.includes('youtube.com') || url.includes('youtu.be')) {
                    if (url.includes('v=')) {
                        const match = url.match(/[?&]v=([^&]+)/);
                        videoId = match ? match[1] : '';
                    } else if (url.includes('youtu.be/')) {
                        const parts = url.split('youtu.be/');
                        videoId = parts[1].split(/[?&]/)[0];
                    } else if (url.length === 11) {
                        videoId = url;
                    }
                } else {
                    videoId = url;
                }
                
                if (videoId) {
                    videoId = videoId.split(/[?&]/)[0];
                    
                    // Load locally
                    player.loadVideoById(videoId);
                    isPlaying = true;
                    document.getElementById('play-pause-btn').textContent = '⏸';
                    
                    // Send to partner
                    if (socket && socket.connected) {
                        socket.emit('video-change', {
                            videoId: videoId,
                            roomId: currentRoomCode
                        });
                        
                        addMessage('System', `Loading video for both of you: ${videoId}`, 'received');
                    }
                } else {
                    addMessage('System', 'Could not extract video ID from the URL. Please check the URL format.', 'received');
                }
            } catch (error) {
                console.error('Error processing video URL:', error);
                addMessage('System', 'Error processing the video URL. Please check the format.', 'received');
            }
        } else if (!playerReady) {
            addMessage('System', 'Player is not ready yet. Please wait...', 'received');
        } else {
            addMessage('System', 'Please enter a valid YouTube URL or video ID.', 'received');
        }
    });
    
    // Send playback command to server
    function sendPlaybackCommand(command) {
        if (socket && socket.connected && currentRoomCode) {
            socket.emit('playback-control', {
                ...command,
                roomId: currentRoomCode
            });
        }
    }
    
    // Screen sharing functionality
    document.getElementById('screen-share-btn').addEventListener('click', function() {
        const screenShareContainer = document.getElementById('screen-share-container');
        const screenShareBtn = this;
        
        if (screenShareContainer.style.display === 'block') {
            // Stop screen sharing
            const videoElement = document.getElementById('screen-share');
            const stream = videoElement.srcObject;
            if (stream) {
                const tracks = stream.getTracks();
                tracks.forEach(track => track.stop());
            }
            videoElement.srcObject = null;
            screenShareContainer.style.display = 'none';
            screenShareBtn.textContent = '🖥️ Share Screen';
            addMessage('System', 'Screen sharing stopped.', 'received');
        } else {
            // Start screen sharing
            navigator.mediaDevices.getDisplayMedia({ 
                video: true,
                audio: true 
            })
            .then(stream => {
                const videoElement = document.getElementById('screen-share');
                videoElement.srcObject = stream;
                screenShareContainer.style.display = 'block';
                screenShareBtn.textContent = '⏹ Stop Sharing';
                addMessage('System', 'Screen sharing started!', 'received');
                
                // Handle stream ending
                stream.getVideoTracks()[0].addEventListener('ended', () => {
                    screenShareContainer.style.display = 'none';
                    screenShareBtn.textContent = '🖥️ Share Screen';
                    addMessage('System', 'Screen sharing ended.', 'received');
                });
            })
            .catch(err => {
                console.error('Error sharing screen:', err);
                addMessage('System', `Screen sharing failed: ${err.message}`, 'received');
            });
        }
    });
    
    // Voice chat functionality
    document.getElementById('voice-btn').addEventListener('mousedown', startVoice);
    document.getElementById('voice-btn').addEventListener('mouseup', stopVoice);
    document.getElementById('voice-btn').addEventListener('mouseleave', stopVoice);
    
    async function startVoice() {
        if (voiceActive) return;
        
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            voiceActive = true;
            document.getElementById('voice-btn').classList.add('active');
            
            // Add tracks to existing peer connections
            for (const id in peerConnections) {
                localStream.getTracks().forEach(track => {
                    peerConnections[id].addTrack(track, localStream);
                });
            }
            
            // Signal to start voice chat
            if (socket && socket.connected) {
                socket.emit('start-voice', { roomId: currentRoomCode });
            }
            
            addMessage('System', 'Voice chat started', 'received');
        } catch (error) {
            console.error('Error accessing microphone:', error);
            addMessage('System', 'Microphone access denied. Please allow microphone access.', 'received');
        }
    }
    
    function stopVoice() {
        if (!voiceActive) return;
        
        voiceActive = false;
        document.getElementById('voice-btn').classList.remove('active');
        
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
    }
    
    // Create WebRTC peer connection
    function createPeerConnection(id) {
        const pc = new RTCPeerConnection({ 
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] 
        });
        
        peerConnections[id] = pc;
        
        // Add local stream if available
        if (localStream) {
            localStream.getTracks().forEach(track => {
                pc.addTrack(track, localStream);
            });
        }
        
        // Handle ICE candidates
        pc.onicecandidate = (event) => {
            if (event.candidate && socket && socket.connected) {
                socket.emit('voice-candidate', { 
                    to: id, 
                    candidate: event.candidate 
                });
            }
        };
        
        // Handle remote stream
        pc.ontrack = (event) => {
            // Create audio element if it doesn't exist
            let audio = document.getElementById(`audio-${id}`);
            if (!audio) {
                audio = document.createElement('audio');
                audio.id = `audio-${id}`;
                audio.autoplay = true;
                // Don't add to DOM, just keep it for audio
            }
            audio.srcObject = event.streams[0];
        };
        
        return pc;
    }
    
    // Fullscreen functionality
    document.getElementById('fullscreen-youtube').addEventListener('click', function() {
        const playerElement = document.querySelector('.video-container');
        if (playerElement.requestFullscreen) {
            playerElement.requestFullscreen();
        } else if (playerElement.webkitRequestFullscreen) {
            playerElement.webkitRequestFullscreen();
        } else if (playerElement.mozRequestFullScreen) {
            playerElement.mozRequestFullScreen();
        }
    });
    
    document.getElementById('fullscreen-screen').addEventListener('click', function() {
        const screenElement = document.getElementById('screen-share-container');
        if (screenElement.requestFullscreen) {
            screenElement.requestFullscreen();
        } else if (screenElement.webkitRequestFullscreen) {
            screenElement.webkitRequestFullscreen();
        } else if (screenElement.mozRequestFullScreen) {
            screenElement.mozRequestFullScreen();
        }
    });
    
    // Initialize
    window.onload = function() {
        createHearts();
        
        // Check for room code in URL
        const roomFromUrl = getRoomFromUrl();
        if (roomFromUrl) {
            document.getElementById('room').value = roomFromUrl;
        }
        
        // Add event listeners for Enter key
        document.getElementById('username').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('login-btn').click();
            }
        });
        
        document.getElementById('room').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('login-btn').click();
            }
        });
        
        document.getElementById('video-url').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('load-btn').click();
            }
        });
        
        // Load YouTube API
        loadYouTubeAPI();
    };
</script>
